# ICR 솔루션 개발자 매뉴얼

/toc

## 1. 개요

### 1-1. 배포 패키지 구조

설치 전 배포 패키지의 디렉토리 구조입니다.

```
icr-solution/
├── install.sh                 # 설치 실행 (래퍼)
├── uninstall.sh               # 제거 실행 (래퍼)
├── setup-permissions.sh       # 권한 복구 (Windows 작업 후)
│
├── packages/                  # 설치 원본
│   ├── apache-tomcat-*.tar.gz # Tomcat 배포판
│   └── icr.war                # 애플리케이션 WAR
│
└── solution/
    ├── bin/                   # 실행 스크립트
    │   ├── install-core.sh    # 설치 코어 로직
    │   ├── uninstall-core.sh  # 제거 코어 로직
    │   ├── start.sh           # 서비스 시작
    │   ├── stop.sh            # 서비스 중지
    │   ├── deploy-war.sh      # WAR 배포
    │   ├── check.sh           # 종합 점검
    │   ├── health.sh          # HTTP 헬스체크
    │   └── health-https.sh    # HTTPS 헬스체크
    │
    ├── config/                # 설정 파일
    │   └── site.conf          # [수정 대상] 환경 설정
    │
    ├── modules/               # 공통 모듈 (수정 불필요)
    │   └── service_control.sh # start/stop 공통 함수
    │
    └── templates/             # 설정 템플릿 (수정 불필요)
        └── tomcat/
            ├── server.xml.tpl     # @TOKEN@ 치환 → server.xml
            ├── web.xml.tpl        # @TOKEN@ 치환 → web.xml
            ├── context.xml.tpl    # @TOKEN@ 치환 → context.xml
            └── setenv.sh.tpl      # @TOKEN@ 치환 → setenv.sh
```

### 1-2. 설정 흐름

```
site.conf (원본 설정)
    ↓ install.sh 실행
templates/*.tpl (@TOKEN@ 치환)
    ↓
$INSTALL_BASE/config/tomcat/* (실제 설정 파일)
    ↓ 심볼릭 링크
$TOMCAT_HOME/conf/*, $TOMCAT_HOME/bin/setenv.sh
```

### 1-3. 설치 후 디렉토리 구조

설치 완료 후 INSTALL_BASE(기본: /opt/icr-solution)에 생성되는 구조입니다.

```
/opt/icr-solution/              # INSTALL_BASE
├── tomcat -> apache-tomcat-*   # TOMCAT_HOME (심볼릭 링크)
│
├── apache-tomcat-10.1.50/      # Tomcat 실제 디렉토리
│   ├── bin/
│   │   └── setenv.sh -> ../../config/tomcat/setenv.sh
│   ├── conf/
│   │   ├── server.xml -> ../../config/tomcat/server.xml
│   │   ├── web.xml -> ../../config/tomcat/web.xml
│   │   └── context.xml -> ../../config/tomcat/context.xml
│   ├── logs/                   # Tomcat 로그 (catalina.out 등)
│   └── icr-webapps/            # WAS_APP_BASE (WAR 배포 디렉토리)
│       └── ROOT/               # 압축 해제된 애플리케이션
│
├── config/
│   └── tomcat/                 # 실제 설정 파일 (여기를 수정)
│       ├── server.xml          # Tomcat 서버 설정
│       ├── web.xml             # 웹 애플리케이션 설정
│       ├── context.xml         # 컨텍스트 설정
│       └── setenv.sh           # JVM 환경 변수
│
├── backup/
│   └── war/                    # WAR 백업 (deploy-war.sh 사용 시)
│
├── logs/                       # 애플리케이션 로그 (예약)
└── data/                       # 데이터 디렉토리 (예약)
```

### 1-4. 설정 파일 위치

설치 후 생성되는 설정 파일 위치입니다.

| 파일 | 위치 | 용도 |
|------|------|------|
| site.conf | solution/config/site.conf | 설치 설정 (원본) |
| server.xml | $INSTALL_BASE/config/tomcat/server.xml | Tomcat 서버 설정 |
| web.xml | $INSTALL_BASE/config/tomcat/web.xml | 웹 애플리케이션 설정 |
| context.xml | $INSTALL_BASE/config/tomcat/context.xml | 컨텍스트 설정 |
| setenv.sh | $INSTALL_BASE/config/tomcat/setenv.sh | JVM 환경 변수 |

설정 파일은 `$INSTALL_BASE/config/tomcat/`에 생성되고, Tomcat의 `conf/`, `bin/` 디렉토리에 심볼릭 링크로 연결됩니다.


## 2. site.conf 설정

### 2-1. 필수 설정 항목

반드시 사이트 환경에 맞게 수정해야 하는 항목입니다.

```bash
# 사이트 식별자
# - 로그, 모니터링에서 인스턴스 구분용
SITE=INFODEA

# Spring Boot 프로파일
# - application.yml에서 적용할 프로파일
ENV=prod

# Java 홈 경로
# - 서버에 설치된 JDK 경로
JAVA_HOME=/usr/lib/jvm/temurin-17

# HTTP 포트
# - 웹 애플리케이션 접속 포트
WAS_HTTP_PORT=28080

# Jasypt 암호화 키
# - application.yml 암호화된 값 복호화용
JASYPT_ENCRYPTOR_PASSWORD=your_secret_key
```

### 2-2. 선택 설정 항목

기본값으로 사용 가능하나, 필요시 변경하는 항목입니다.

```bash
# 설치 기본 경로
INSTALL_BASE=/opt/icr-solution

# Tomcat 심볼릭 링크 경로
TOMCAT_HOME=/opt/icr-solution/tomcat

# Tomcat 배포판 이름
TOMCAT_DIST_NAME=apache-tomcat-10.1.50

# 앱 배포 디렉토리 (TOMCAT_HOME 기준 상대경로)
WAS_APP_BASE=icr-webapps

# HTTPS 포트
WAS_HTTPS_PORT=28443

# HTTPS 활성화 여부
WAS_ENABLE_HTTPS=Y

# 외부 설정 디렉토리
ICR_CONFIG_DIR=/opt/icr-solution/config

# JVM 힙 메모리
JVM_XMS=512m
JVM_XMX=1024m

# 타임존
JVM_TIMEZONE=Asia/Seoul

# 파일 인코딩
JVM_ENCODING=UTF-8
```

### 2-3. 고급 설정 항목

특수 상황에서만 변경하는 항목입니다.

```bash
# Tomcat Shutdown 포트
# - 동일 서버 다중 인스턴스 시 변경 필요
WAS_SHUTDOWN_PORT=8005

# SSL 인증서 파일명
# - HTTPS 사용 시 $TOMCAT_HOME/conf/ 에 위치
WAS_SSL_KEYSTORE_FILE=localhost-rsa.jks

# SSL 인증서 비밀번호
WAS_SSL_KEYSTORE_PASSWORD=changeit

# 서비스 타임아웃 설정
SVC_START_TIMEOUT_SEC=30
SVC_STOP_TIMEOUT_SEC=30
SVC_STOP_FORCEKILL=Y
SVC_STOP_FORCEKILL_GRACE_SEC=1
```


## 3. 환경별 설정 예시

### 3-1. 개발 환경 (dev)

개발 환경에서 권장하는 설정입니다.

```bash
# ═══════════════════════════════════════════════
# 개발 환경 설정 예시
# ═══════════════════════════════════════════════

# 사이트 식별
SITE=DEV_LOCAL
ENV=dev

# 경로
JAVA_HOME=/usr/lib/jvm/temurin-17
INSTALL_BASE=/opt/icr-solution
TOMCAT_HOME=/opt/icr-solution/tomcat

# 포트 (개발 환경 기본)
WAS_HTTP_PORT=8080
WAS_HTTPS_PORT=8443
WAS_SHUTDOWN_PORT=8005

# HTTPS (개발환경에서는 비활성화 가능)
WAS_ENABLE_HTTPS=N

# JVM (개발환경은 낮게 설정)
JVM_XMS=256m
JVM_XMX=512m

# Jasypt 키 (개발용)
JASYPT_ENCRYPTOR_PASSWORD=dev_secret_key
```

### 3-2. 스테이징 환경 (staging)

스테이징 환경에서 권장하는 설정입니다.

```bash
# ═══════════════════════════════════════════════
# 스테이징 환경 설정 예시
# ═══════════════════════════════════════════════

# 사이트 식별
SITE=STAGING
ENV=staging

# 경로
JAVA_HOME=/usr/lib/jvm/temurin-17
INSTALL_BASE=/opt/icr-solution
TOMCAT_HOME=/opt/icr-solution/tomcat

# 포트 (운영과 동일하게)
WAS_HTTP_PORT=28080
WAS_HTTPS_PORT=28443
WAS_SHUTDOWN_PORT=8005

# HTTPS (운영과 동일하게 활성화)
WAS_ENABLE_HTTPS=Y
WAS_SSL_KEYSTORE_FILE=staging-cert.jks
WAS_SSL_KEYSTORE_PASSWORD=staging_password

# JVM (운영과 유사하게)
JVM_XMS=512m
JVM_XMX=1024m

# Jasypt 키
JASYPT_ENCRYPTOR_PASSWORD=staging_secret_key
```

### 3-3. 운영 환경 (prod)

운영 환경에서 권장하는 설정입니다.

```bash
# ═══════════════════════════════════════════════
# 운영 환경 설정 예시
# ═══════════════════════════════════════════════

# 사이트 식별
SITE=PRODUCTION
ENV=prod

# 경로
JAVA_HOME=/usr/lib/jvm/temurin-17
INSTALL_BASE=/opt/icr-solution
TOMCAT_HOME=/opt/icr-solution/tomcat

# 포트
WAS_HTTP_PORT=28080
WAS_HTTPS_PORT=28443
WAS_SHUTDOWN_PORT=8005

# HTTPS (운영에서는 필수)
WAS_ENABLE_HTTPS=Y
WAS_SSL_KEYSTORE_FILE=production-cert.jks
WAS_SSL_KEYSTORE_PASSWORD=production_secure_password

# JVM (서버 메모리에 따라 조정)
JVM_XMS=2g
JVM_XMX=4g

# Jasypt 키 (운영용 별도 관리)
JASYPT_ENCRYPTOR_PASSWORD=production_secret_key
```


## 4. HTTPS 설정

### 4-1. 인증서 준비

HTTPS 사용을 위해 SSL 인증서가 필요합니다.

**JKS 형식 인증서 준비:**

```bash
# PEM을 JKS로 변환 (기존 인증서가 있는 경우)
openssl pkcs12 -export -in certificate.crt -inkey private.key \
    -out certificate.p12 -name tomcat

keytool -importkeystore -srckeystore certificate.p12 \
    -srcstoretype PKCS12 -destkeystore certificate.jks \
    -deststoretype JKS
```

**자체 서명 인증서 생성 (테스트용):**

```bash
keytool -genkeypair -alias tomcat -keyalg RSA -keysize 2048 \
    -validity 365 -keystore test-cert.jks \
    -dname "CN=localhost, OU=Test, O=Test, L=Seoul, ST=Seoul, C=KR"
```

### 4-2. site.conf 설정

인증서 파일을 Tomcat conf 디렉토리에 복사하고 site.conf를 설정합니다.

```bash
# 인증서 파일 복사
cp certificate.jks /opt/icr-solution/tomcat/conf/

# site.conf 설정
WAS_ENABLE_HTTPS=Y
WAS_SSL_KEYSTORE_FILE=certificate.jks
WAS_SSL_KEYSTORE_PASSWORD=your_keystore_password
```

설정 변경 후 서비스를 재시작합니다.

```bash
./solution/bin/stop.sh
./solution/bin/start.sh
```

### 4-3. 인증서 갱신

인증서 만료 시 갱신 절차입니다.

```bash
# 1. 새 인증서 파일 복사
cp new-certificate.jks /opt/icr-solution/tomcat/conf/

# 2. site.conf 수정 (파일명이 변경된 경우)
vi solution/config/site.conf
# WAS_SSL_KEYSTORE_FILE=new-certificate.jks

# 3. 설정 재생성 및 재시작
ICR_FORCE_REGEN=Y ./install.sh
./solution/bin/stop.sh
./solution/bin/start.sh

# 4. HTTPS 헬스체크
./solution/bin/health-https.sh --verify
```


## 5. JVM 튜닝

### 5-1. 메모리 설정

서버 가용 메모리에 따라 힙 메모리를 조정합니다.

| 서버 메모리 | JVM_XMS | JVM_XMX |
|-------------|---------|---------|
| 4GB | 512m | 1g |
| 8GB | 1g | 2g |
| 16GB | 2g | 4g |
| 32GB | 4g | 8g |

```bash
# site.conf 설정
JVM_XMS=2g
JVM_XMX=4g
```

**메모리 설정 원칙:**
- XMS와 XMX는 동일하게 설정하는 것을 권장
- 서버 가용 메모리의 50~70%를 XMX로 설정
- 나머지는 OS와 기타 프로세스용으로 확보

### 5-2. GC 설정

Java 17 이상에서는 G1GC가 기본입니다. 추가 튜닝이 필요한 경우 setenv.sh.tpl을 수정합니다.

**setenv.sh.tpl에 GC 옵션 추가:**

```bash
# GC 설정 (Java 17+에서는 G1GC가 기본)
export JAVA_OPTS="$JAVA_OPTS -XX:+UseG1GC"
export JAVA_OPTS="$JAVA_OPTS -XX:MaxGCPauseMillis=200"

# GC 로그 (Java 17+ 형식)
export JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:file=${CATALINA_HOME}/logs/gc.log:time,uptime:filecount=5,filesize=10M"

# 힙 덤프 (OOM 발생 시 자동 생성)
export JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError"
export JAVA_OPTS="$JAVA_OPTS -XX:HeapDumpPath=${CATALINA_HOME}/logs/"
```

### 5-3. 디버그 모드

원격 디버깅이 필요한 경우 설정합니다.

**setenv.sh.tpl에 디버그 옵션 추가:**

```bash
# 디버그 모드 (개발환경 전용)
export JAVA_OPTS="$JAVA_OPTS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
```

**IDE에서 원격 디버그 연결:**
- Host: 서버 IP
- Port: 5005
- Transport: Socket


## 6. 다중 인스턴스

### 6-1. 포트 분리

동일 서버에서 여러 인스턴스를 운영하려면 포트를 분리합니다.

**인스턴스 1 (기본):**

```bash
WAS_HTTP_PORT=28080
WAS_HTTPS_PORT=28443
WAS_SHUTDOWN_PORT=8005
```

**인스턴스 2:**

```bash
WAS_HTTP_PORT=28081
WAS_HTTPS_PORT=28444
WAS_SHUTDOWN_PORT=8006
```

**인스턴스 3:**

```bash
WAS_HTTP_PORT=28082
WAS_HTTPS_PORT=28445
WAS_SHUTDOWN_PORT=8007
```

### 6-2. 디렉토리 분리

인스턴스별로 별도 디렉토리를 사용합니다.

```bash
# 인스턴스 1
INSTALL_BASE=/opt/icr-solution-1
TOMCAT_HOME=/opt/icr-solution-1/tomcat

# 인스턴스 2
INSTALL_BASE=/opt/icr-solution-2
TOMCAT_HOME=/opt/icr-solution-2/tomcat

# 인스턴스 3
INSTALL_BASE=/opt/icr-solution-3
TOMCAT_HOME=/opt/icr-solution-3/tomcat
```

**다중 인스턴스 설치 예시:**

```bash
# 인스턴스 1 설치
cd /opt/icr-solution-1
vi solution/config/site.conf  # 포트 및 경로 설정
./install.sh

# 인스턴스 2 설치
cd /opt/icr-solution-2
vi solution/config/site.conf  # 포트 및 경로 설정
./install.sh
```


## 7. FAQ

### 7-1. 설정 변경 후 반영 방법

**site.conf 변경 후:**

1. 기존 설정 유지하며 재설치 (Tomcat만 재설치):
```bash
./uninstall.sh
./install.sh
```

2. 설정 파일 강제 재생성:
```bash
ICR_FORCE_REGEN=Y ./install.sh
```

3. 서비스만 재시작 (site.conf 변경이 JVM 옵션에만 해당하는 경우):
```bash
./solution/bin/stop.sh
./solution/bin/start.sh
```

### 7-2. 로그 확인 방법

**Tomcat 로그:**

```bash
# 실시간 로그 확인
tail -f /opt/icr-solution/tomcat/logs/catalina.out

# 최근 500줄 확인
tail -500 /opt/icr-solution/tomcat/logs/catalina.out

# 에러만 필터링
grep -i error /opt/icr-solution/tomcat/logs/catalina.out | tail -100
```

**액세스 로그:**

```bash
# 오늘 액세스 로그
tail -f /opt/icr-solution/tomcat/logs/localhost_access_log.$(date +%Y-%m-%d).txt
```

**check.sh로 로그 확인:**

```bash
# 최근 100줄 출력
./solution/bin/check.sh --tail 100
```

### 7-3. 인증서 오류 해결

**증상: HTTPS 헬스체크 실패 (FAIL 000)**

```bash
# 인증서 파일 존재 확인
ls -la /opt/icr-solution/tomcat/conf/*.jks

# 인증서 정보 확인
keytool -list -v -keystore /opt/icr-solution/tomcat/conf/certificate.jks

# site.conf 설정 확인
grep -E 'WAS_SSL|WAS_ENABLE_HTTPS' solution/config/site.conf
```

**증상: 인증서 비밀번호 오류**

Tomcat 로그에서 다음과 같은 메시지가 나타납니다:
```
java.io.IOException: Keystore was tampered with, or password was incorrect
```

해결: site.conf의 WAS_SSL_KEYSTORE_PASSWORD가 인증서 생성 시 사용한 비밀번호와 일치하는지 확인합니다.

**증상: 인증서 만료**

```bash
# 인증서 만료일 확인
keytool -list -v -keystore /opt/icr-solution/tomcat/conf/certificate.jks | grep Valid
```

해결: 새 인증서를 발급받아 갱신합니다. (4-3. 인증서 갱신 참고)
