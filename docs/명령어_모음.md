# ICR 솔루션 명령어 모음

/toc

이 문서는 ICR 솔루션의 모든 명령어와 옵션을 정리한 레퍼런스입니다.

---

## 1. 빠른 시작

### 1-1. 3단계 설치

```bash
# 1. 설정 파일 수정
vi solution/config/site.conf

# 2. 설치 실행
./install.sh

# 3. 서비스 시작
./solution/bin/start.sh
```

### 1-2. 최소 필수 설정 (site.conf)

```bash
SITE=MYSITE                    # 사이트 식별자
ENV=prod                       # Spring 프로파일
JAVA_HOME=/usr/lib/jvm/java-21 # Java 경로 (JAVA_SOURCE=system 시)
WAS_HTTP_PORT=28080            # HTTP 포트
JASYPT_ENCRYPTOR_PASSWORD=xxx  # 암호화 키
```

---

## 2. 설치 / 제거

### 2-1. install.sh - 설치

**기본 사용법:**

```bash
./install.sh
```

**환경변수 옵션:**

| 환경변수 | 값 | 설명 |
|---------|-----|------|
| `ICR_FORCE_REGEN` | Y/N | 설정 파일 강제 재생성 (기본: N) |

**사용 예시:**

```bash
# 기본 설치 (기존 설정 유지)
./install.sh

# 설정 파일 강제 재생성 (site.conf 변경 후)
ICR_FORCE_REGEN=Y ./install.sh
```

**동작 설명:**

- `ICR_FORCE_REGEN=N` (기본): 기존 설정 파일이 있으면 유지
- `ICR_FORCE_REGEN=Y`: 기존 파일을 `.bak.YYYYMMDD_HHMMSS` 형식으로 백업 후 재생성

### 2-2. uninstall.sh - 제거

**옵션:**

| 옵션 | 설명 |
|------|------|
| (없음) | Tomcat만 삭제 (config/logs/data 유지) |
| `--full` | 전체 삭제 (config/logs/data 포함) |
| `--dry-run` | 삭제 대상만 미리보기 (실제 삭제 안 함) |
| `--force` | 확인 없이 강제 삭제 |
| `-h, --help` | 도움말 |

**사용 예시:**

```bash
# Tomcat만 삭제 (설정/로그/데이터 유지)
./uninstall.sh

# 삭제 대상 미리보기
./uninstall.sh --dry-run

# 전체 삭제 미리보기
./uninstall.sh --full --dry-run

# 전체 강제 삭제 (확인 없이)
./uninstall.sh --full --force
```

---

## 3. 서비스 제어

### 3-1. start.sh - 시작

**기본 사용법:**

```bash
./solution/bin/start.sh
```

**동작:**

1. site.conf 로드
2. Tomcat 실행 여부 확인 (이미 실행 중이면 종료)
3. `$TOMCAT_HOME/bin/startup.sh` 실행
4. 프로세스 시작 대기 (SVC_START_TIMEOUT_SEC)
5. 시작 성공/실패 출력

**종료 코드:**

| 코드 | 의미 |
|------|------|
| 0 | 시작 성공 |
| 1 | 시작 실패 또는 이미 실행 중 |

### 3-2. stop.sh - 중지

**기본 사용법:**

```bash
./solution/bin/stop.sh
```

**동작:**

1. site.conf 로드
2. Tomcat 실행 여부 확인 (실행 중이 아니면 종료)
3. `$TOMCAT_HOME/bin/shutdown.sh` 실행
4. 프로세스 종료 대기 (SVC_STOP_TIMEOUT_SEC)
5. 타임아웃 시 강제 종료 (SVC_STOP_FORCEKILL=Y인 경우)

**관련 site.conf 설정:**

```bash
SVC_START_TIMEOUT_SEC=30        # 시작 대기 시간 (초)
SVC_STOP_TIMEOUT_SEC=30         # 중지 대기 시간 (초)
SVC_STOP_FORCEKILL=Y            # 타임아웃 시 강제 종료 (Y/N)
SVC_STOP_FORCEKILL_GRACE_SEC=1  # 강제 종료 후 대기 (초)
```

### 3-3. 서비스 제어 흐름

```
[start.sh]
    │
    ├── 이미 실행 중? ──Yes──> "Already running" 출력, 종료
    │
    No
    │
    ├── startup.sh 실행
    │
    └── 프로세스 대기 (최대 SVC_START_TIMEOUT_SEC초)
        │
        ├── 성공 → "Started successfully"
        └── 실패 → "Failed to start"

[stop.sh]
    │
    ├── 실행 중 아님? ──Yes──> "Not running" 출력, 종료
    │
    No
    │
    ├── shutdown.sh 실행
    │
    └── 프로세스 종료 대기 (최대 SVC_STOP_TIMEOUT_SEC초)
        │
        ├── 정상 종료 → "Stopped successfully"
        │
        └── 타임아웃 → SVC_STOP_FORCEKILL=Y?
                       │
                       ├── Yes → kill -9 실행 → "Force killed"
                       └── No  → "Failed to stop"
```

---

## 4. WAR 배포

### 4-1. deploy-war.sh - WAR 배포

**옵션:**

| 옵션 | 인자 | 설명 | 기본값 |
|------|------|------|--------|
| `--war` | `<path>` | 배포할 WAR 파일 경로 | packages/icr.war |
| `--restart` | - | 배포 후 재기동 | (기본 동작) |
| `--no-restart` | - | 배포만 (재기동 안 함) | - |
| `--keep` | `<N>` | 백업 보관 개수 | 20 |
| `--wait-health` | - | 재기동 후 헬스체크 대기 | - |
| `--health-path` | `<path>` | 헬스체크 URL 경로 | /icr/login |
| `--health-retry` | `<N>` | 헬스체크 재시도 횟수 | 30 |
| `--health-interval` | `<sec>` | 재시도 간격 (초) | 2 |
| `--check-https` | - | HTTP + HTTPS 둘 다 체크 | - |
| `--dry-run` | - | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | - | 도움말 | - |

**사용 예시:**

```bash
# 기본 배포 (packages/icr.war → 재기동)
./solution/bin/deploy-war.sh

# WAR만 교체 (재기동 없음)
./solution/bin/deploy-war.sh --no-restart

# 특정 WAR 파일 배포
./solution/bin/deploy-war.sh --war /tmp/myapp.war

# 배포 + 헬스체크 대기
./solution/bin/deploy-war.sh --wait-health

# 배포 + 헬스체크 (커스텀 경로)
./solution/bin/deploy-war.sh --wait-health --health-path /api/health

# 배포 + HTTP/HTTPS 모두 검증 (CI/CD용)
./solution/bin/deploy-war.sh --wait-health --check-https --health-retry 10

# 배포 시뮬레이션
./solution/bin/deploy-war.sh --dry-run
```

### 4-2. 배포 프로세스

```
deploy-war.sh 실행
    │
    ├── 기존 WAR 백업 ($INSTALL_BASE/backup/war/)
    │
    ├── 새 WAR 복사 → $TOMCAT_HOME/$WAS_APP_BASE/
    │
    ├── 오래된 백업 정리 (--keep N개 초과분 삭제)
    │
    ├── --no-restart? ──Yes──> 종료
    │
    No
    │
    ├── stop.sh 실행
    │
    ├── 기존 ROOT 디렉토리 삭제
    │
    ├── start.sh 실행
    │
    └── --wait-health? ──Yes──> 헬스체크 대기
                        │
                        └── --check-https? ──Yes──> HTTPS도 체크
```

### 4-3. 배포 실패 시 롤백

```bash
# 1. 서비스 중지
./solution/bin/stop.sh

# 2. 백업에서 복원
cp $INSTALL_BASE/backup/war/icr.war.YYYYMMDD_HHMMSS \
   $TOMCAT_HOME/$WAS_APP_BASE/icr.war

# 3. 기존 ROOT 디렉토리 삭제
rm -rf $TOMCAT_HOME/$WAS_APP_BASE/ROOT

# 4. 서비스 시작
./solution/bin/start.sh
```

---

## 5. 헬스체크

### 5-1. health.sh - HTTP 헬스체크

**옵션:**

| 옵션 | 인자 | 설명 | 기본값 |
|------|------|------|--------|
| `--path` | `<path>` | 체크할 URL 경로 | /icr/login |
| `--timeout` | `<sec>` | curl 타임아웃 | 5 |
| `--retry` | `<N>` | 재시도 횟수 | 3 |
| `--interval` | `<sec>` | 재시도 간격 | 1 |
| `--verbose` | - | 실패 시 응답 헤더 출력 | - |
| `--dry-run` | - | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | - | 도움말 | - |

**사용 예시:**

```bash
# 기본 헬스체크
./solution/bin/health.sh

# 커스텀 경로 체크
./solution/bin/health.sh --path /api/health

# 재시도 횟수 증가 (앱 워밍업 대기)
./solution/bin/health.sh --retry 10 --interval 3

# 상세 출력 (디버깅용)
./solution/bin/health.sh --verbose
```

**출력 상태:**

| 상태 | 의미 |
|------|------|
| `OK` | HTTP 200, 30x, 401, 403 응답 |
| `WARMING UP` | HTTP 000 (연결 대기 중, 재시도 계속) |
| `FAIL` | HTTP 4xx/5xx (401, 403 제외) 또는 타임아웃 |

> **참고:** 401(Unauthorized), 403(Forbidden)은 인증 필요 페이지이므로 성공으로 판정합니다.

### 5-2. health-https.sh - HTTPS 헬스체크

**옵션:**

| 옵션 | 인자 | 설명 | 기본값 |
|------|------|------|--------|
| `--path` | `<path>` | 체크할 URL 경로 | /icr/login |
| `--timeout` | `<sec>` | curl 타임아웃 | 5 |
| `--retry` | `<N>` | 재시도 횟수 | 3 |
| `--interval` | `<sec>` | 재시도 간격 | 1 |
| `--verify` | - | TLS 인증서 검증 ON | OFF |
| `--verbose` | - | 실패 시 응답 헤더 출력 | - |
| `--dry-run` | - | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | - | 도움말 | - |

**사용 예시:**

```bash
# 기본 HTTPS 체크 (인증서 검증 OFF)
./solution/bin/health-https.sh

# 인증서 검증 포함
./solution/bin/health-https.sh --verify

# 커스텀 경로 + 인증서 검증
./solution/bin/health-https.sh --path /api/health --verify
```

### 5-3. WARMING UP 상태 이해

헬스체크 시 **HTTP 000** 응답이 발생하면 `WARMING UP` 상태로 표시됩니다.

**의미:**
- Tomcat 프로세스는 시작되었으나 아직 요청 처리 준비 중
- 애플리케이션 초기화(Spring Context 로딩 등) 진행 중
- **FAIL이 아님** - 재시도가 계속 진행됨

**대응:**
- `--retry` 옵션으로 재시도 횟수 증가
- 무거운 앱은 `--retry 30 --interval 2` 정도 권장

---

## 6. 종합 점검

### 6-1. check.sh - 종합 점검

**옵션:**

| 옵션 | 인자 | 설명 | 기본값 |
|------|------|------|--------|
| `--with-health` | - | 헬스체크 포함 | - |
| `--health-path` | `<path>` | 헬스체크 URL 경로 | /icr/login |
| `--health-retry` | `<N>` | 헬스체크 재시도 횟수 | 3 |
| `--health-interval` | `<sec>` | 재시도 간격 | 1 |
| `--tail` | `<N>` | catalina.out 마지막 N줄 출력 | - |
| `--dry-run` | - | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | - | 도움말 | - |

**사용 예시:**

```bash
# 기본 점검 (프로세스 상태만)
./solution/bin/check.sh

# 헬스체크 포함
./solution/bin/check.sh --with-health

# 헬스체크 + 로그 출력
./solution/bin/check.sh --with-health --tail 50

# 종합 점검 (실전 권장)
./solution/bin/check.sh --with-health --health-retry 5 --tail 100
```

### 6-2. 점검 출력 해석

```
=== ICR Solution Status Check ===

[Configuration]
  SITE: INFODEA
  ENV: prod
  JAVA_HOME: /usr/lib/jvm/temurin-21
  TOMCAT_HOME: /opt/icr-solution/tomcat
  HTTP_PORT: 28080

[Process Status]
  Tomcat PID: 12345
  Status: RUNNING
  Uptime: 2 days, 3:45:12

[Port Status]
  HTTP (28080): LISTENING
  HTTPS (28443): LISTENING

[Health Check]              # --with-health 옵션 시
  HTTP: OK (200)
  HTTPS: OK (200)

[Recent Logs]               # --tail 옵션 시
  ... (catalina.out 마지막 N줄)
```

---

## 7. site.conf 레퍼런스

### 7-1. 필수 설정

| 변수 | 설명 | 예시 |
|------|------|------|
| `SITE` | 사이트 식별자 | INFODEA, KBANK |
| `ENV` | Spring 프로파일 | dev, staging, prod |
| `JAVA_HOME` | Java 경로 (JAVA_SOURCE=system) | /usr/lib/jvm/temurin-21 |
| `WAS_HTTP_PORT` | HTTP 포트 | 8080, 28080 |
| `JASYPT_ENCRYPTOR_PASSWORD` | 암호화 키 | (운영환경 고유값) |

### 7-2. 선택 설정

| 변수 | 설명 | 기본값 |
|------|------|--------|
| `JAVA_SOURCE` | Java 소스 선택 | system |
| `INSTALL_BASE` | 설치 경로 | /opt/icr-solution |
| `TOMCAT_HOME` | Tomcat 경로 | /opt/icr-solution/tomcat |
| `TOMCAT_DIST_NAME` | Tomcat 배포판명 | apache-tomcat-10.1.50 |
| `WAS_APP_BASE` | WAR 배포 디렉토리 | icr-webapps |
| `WAS_HTTPS_PORT` | HTTPS 포트 | 28443 |
| `WAS_ENABLE_HTTPS` | HTTPS 활성화 | N |
| `ICR_CONFIG_DIR` | 외부 설정 디렉토리 | /opt/icr-solution/config |
| `JVM_XMS` | 힙 초기 크기 | 512m |
| `JVM_XMX` | 힙 최대 크기 | 1024m |
| `JVM_TIMEZONE` | 타임존 | Asia/Seoul |
| `JVM_ENCODING` | 파일 인코딩 | UTF-8 |

### 7-3. 고급 설정

| 변수 | 설명 | 기본값 |
|------|------|--------|
| `WAS_SHUTDOWN_PORT` | Tomcat 종료 포트 | 8005 |
| `WAS_SSL_KEYSTORE_FILE` | SSL 인증서 파일 | localhost-rsa.jks |
| `WAS_SSL_KEYSTORE_PASSWORD` | SSL 비밀번호 | changeit |
| `SVC_START_TIMEOUT_SEC` | 시작 대기 시간 | 30 |
| `SVC_STOP_TIMEOUT_SEC` | 중지 대기 시간 | 30 |
| `SVC_STOP_FORCEKILL` | 강제 종료 허용 | Y |
| `SVC_STOP_FORCEKILL_GRACE_SEC` | 강제 종료 후 대기 | 1 |

---

## 8. 경로 맵

### 8-1. 패키지 구조 (설치 전)

```
icr-solution/                   # 배포 패키지 루트
├── README.md                   # 빠른 시작 가이드
├── install.sh                  # 설치 래퍼
├── uninstall.sh                # 제거 래퍼
├── setup-permissions.sh        # 권한 복구 (Windows 작업 후)
├── logging.sh                  # 공통 로깅 모듈
│
├── docs/                       # 문서
│   ├── 01.ICR_솔루션_개발자_메뉴얼.pdf
│   ├── 02.ICR_솔루션_운영자_메뉴얼.pdf
│   └── 03.ICR_솔루션_명령어_모음.pdf
│
├── packages/                   # 설치 원본
│   ├── apache-tomcat-*.tar.gz  # Tomcat 배포판
│   ├── icr.war                 # 애플리케이션 WAR
│   ├── JDK21_x64.tar.gz        # 번들 JDK (x64)
│   └── JDK21_arm.tar.gz        # 번들 JDK (ARM64)
│
└── solution/
    ├── bin/                    # 실행 스크립트
    ├── config/site.conf        # 설정 파일
    ├── modules/                # 공통 모듈
    ├── templates/              # 설정 템플릿
    └── logs/                   # 스크립트 실행 로그
```

### 8-2. 설치 후 구조 (INSTALL_BASE)

```
/opt/icr-solution/              # INSTALL_BASE
├── tomcat -> apache-tomcat-*   # Tomcat 심볼릭 링크
├── apache-tomcat-10.1.50/      # Tomcat 실제 디렉토리
│   ├── bin/
│   │   └── setenv.sh -> ../../config/tomcat/setenv.sh
│   ├── conf/
│   │   ├── server.xml -> ../../config/tomcat/server.xml
│   │   ├── web.xml -> ../../config/tomcat/web.xml
│   │   └── context.xml -> ../../config/tomcat/context.xml
│   ├── logs/                   # Tomcat 로그 (catalina.out 등)
│   └── icr-webapps/            # WAR 배포 디렉토리
│       └── ROOT/               # 압축 해제된 앱
│
├── java -> jdk-21.0.9+10       # Java 심볼릭 (bundled 시)
├── jdk-21.0.9+10/              # 번들 JDK (bundled 시)
│
├── config/
│   └── tomcat/                 # 실제 설정 파일
│       ├── server.xml
│       ├── web.xml
│       ├── context.xml
│       └── setenv.sh
│
├── backup/
│   └── war/                    # WAR 백업
│
├── logs/                       # 앱 로그 (ICR_LOG_PATH)
└── data/                       # 데이터 디렉토리
```

### 8-3. 주요 파일 위치

| 용도 | 경로 |
|------|------|
| 설치 설정 | `solution/config/site.conf` |
| Tomcat 설정 | `$INSTALL_BASE/config/tomcat/` |
| Tomcat 로그 | `$TOMCAT_HOME/logs/` |
| 앱 로그 | `$INSTALL_BASE/logs/` |
| WAR 백업 | `$INSTALL_BASE/backup/war/` |
| 스크립트 로그 | `solution/logs/` |

---

## 9. 트러블슈팅

### 9-1. 종료 코드 참조

| 코드 | 의미 | 조치 |
|------|------|------|
| 0 | 성공 | - |
| 1 | 일반 오류 | 스크립트 로그 확인 |
| 2 | 설정 오류 | site.conf 확인 |
| 3 | WAR 없음 | packages/icr.war 확인 |
| 4 | 헬스체크 실패 | 앱 로그 확인 |

### 9-2. 자주 발생하는 문제

#### 문제 1: 시작 실패 - 포트 충돌

**증상:**
```
[ERROR] Failed to start Tomcat
```

**확인:**
```bash
# 포트 사용 확인
netstat -tlnp | grep 28080
lsof -i :28080
```

**해결:**
```bash
# 점유 프로세스 종료 또는
# site.conf에서 포트 변경
WAS_HTTP_PORT=28081
```

#### 문제 2: 헬스체크 실패 - 앱 로딩 지연

**증상:**
```
[FAIL] Health check failed after 3 retries
```

**확인:**
```bash
# 상세 헬스체크
./solution/bin/health.sh --verbose

# 앱 로그 확인
tail -f $INSTALL_BASE/logs/*.log
```

**해결:**
```bash
# 재시도 횟수 증가
./solution/bin/deploy-war.sh --wait-health --health-retry 30 --health-interval 3
```

#### 문제 3: Java not found

**증상:**
```
[ERROR] JAVA_HOME is not set or java not found
```

**확인:**
```bash
# Java 경로 확인
which java
java -version
```

**해결:**
```bash
# site.conf 수정
JAVA_HOME=/usr/lib/jvm/temurin-21

# 또는 번들 JDK 사용
JAVA_SOURCE=bundled
```

#### 문제 4: 권한 오류 (Permission denied)

**증상:**
```
bash: ./solution/bin/start.sh: Permission denied
```

**확인:**
```bash
ls -la solution/bin/
```

**해결:**
```bash
# 권한 복구
bash setup-permissions.sh

# 또는 수동
chmod +x solution/bin/*.sh
chmod +x install.sh uninstall.sh
```

#### 문제 5: 설정 변경이 적용 안 됨

**증상:**
- site.conf 수정했는데 변경 안 됨

**원인:**
- 기존 설정 파일이 유지됨 (ICR_FORCE_REGEN=N)

**해결:**
```bash
# 설정 강제 재생성
ICR_FORCE_REGEN=Y ./install.sh

# 서비스 재시작
./solution/bin/stop.sh
./solution/bin/start.sh
```

#### 문제 6: HTTPS 인증서 오류

**증상:**
```
[FAIL] HTTPS health check failed
curl: (60) SSL certificate problem
```

**확인:**
```bash
# 인증서 없이 테스트
./solution/bin/health-https.sh

# 인증서 검증 테스트
./solution/bin/health-https.sh --verify --verbose
```

**해결:**
```bash
# 1. 인증서 파일 위치 확인
ls -la $TOMCAT_HOME/conf/*.jks

# 2. site.conf 설정 확인
WAS_SSL_KEYSTORE_FILE=certificate.jks
WAS_SSL_KEYSTORE_PASSWORD=your_password

# 3. 설정 재생성
ICR_FORCE_REGEN=Y ./install.sh
```

#### 문제 7: OutOfMemoryError

**증상:**
- 앱 로그에 `java.lang.OutOfMemoryError`

**확인:**
```bash
# 현재 힙 설정 확인
grep -E "Xms|Xmx" $INSTALL_BASE/config/tomcat/setenv.sh
```

**해결:**
```bash
# site.conf 수정
JVM_XMS=2g
JVM_XMX=4g

# 설정 재생성 및 재시작
ICR_FORCE_REGEN=Y ./install.sh
./solution/bin/stop.sh
./solution/bin/start.sh
```

### 9-3. 로그 확인 위치

| 로그 종류 | 위치 |
|----------|------|
| 스크립트 실행 로그 | `solution/logs/{스크립트명}-YYYYMMDD.log` |
| Tomcat 기동 로그 | `$TOMCAT_HOME/logs/catalina.out` |
| 앱 로그 | `$INSTALL_BASE/logs/` |
| 접근 로그 | `$TOMCAT_HOME/logs/localhost_access_log.*.txt` |

**로그 실시간 확인:**

```bash
# Tomcat 로그
tail -f $TOMCAT_HOME/logs/catalina.out

# 앱 로그
tail -f $INSTALL_BASE/logs/*.log

# 스크립트 로그
tail -f solution/logs/start-$(date +%Y%m%d).log
```

---

## 부록: 명령어 빠른 참조

### 일상 운영

```bash
# 시작/중지
./solution/bin/start.sh
./solution/bin/stop.sh

# 상태 확인
./solution/bin/check.sh --with-health

# WAR 배포
./solution/bin/deploy-war.sh --wait-health
```

### CI/CD 파이프라인

```bash
# 배포 + HTTP/HTTPS 검증
./solution/bin/deploy-war.sh \
    --wait-health \
    --check-https \
    --health-retry 30 \
    --health-interval 2

# 종료 코드로 성공/실패 판단
echo "Exit code: $?"
```

### 긴급 대응

```bash
# 빠른 상태 확인
./solution/bin/check.sh --tail 100

# 강제 재시작
./solution/bin/stop.sh && ./solution/bin/start.sh

# 헬스체크 상세
./solution/bin/health.sh --verbose
```

---

## 관련 문서

| 문서 | 용도 |
|------|------|
| [운영자_매뉴얼.md](운영자_매뉴얼.md) | 설치부터 운영까지 상세 가이드 |
| [개발자_매뉴얼.md](개발자_매뉴얼.md) | 설정 커스터마이징, 템플릿, 모듈 가이드 |
