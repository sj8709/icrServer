# ICR 솔루션 운영자 매뉴얼

/toc

## 1. 패키지 구조

### 1-1. 배포 패키지 구조

설치 전 배포 패키지의 디렉토리 구조입니다.

```
icr-solution/
├── README.md                  # 빠른 시작 가이드
├── install.sh                 # 설치 실행
├── uninstall.sh               # 제거 실행
├── setup-permissions.sh       # 권한 복구 (Windows 작업 후)
├── logging.sh                 # 공통 로깅 모듈
│
├── docs/                      # 문서
│   ├── 01.ICR_솔루션_개발자_메뉴얼.pdf
│   ├── 02.ICR_솔루션_운영자_메뉴얼.pdf
│   └── 03.ICR_솔루션_명령어_모음.pdf
│
├── packages/                  # 설치 원본
│   ├── apache-tomcat-*.tar.gz # Tomcat 배포판
│   ├── JDK21_x64.tar.gz       # 번들 JDK (Intel/AMD)
│   ├── JDK21_arm.tar.gz       # 번들 JDK (ARM64)
│   └── icr.war                # 애플리케이션 WAR (WAR_NAME으로 변경 가능)
│
└── solution/
    ├── bin/                   # 운영 스크립트
    │   ├── start.sh           # 서비스 시작
    │   ├── stop.sh            # 서비스 중지
    │   ├── deploy-war.sh      # WAR 배포
    │   ├── check.sh           # 종합 점검
    │   ├── health.sh          # HTTP 헬스체크
    │   └── health-https.sh    # HTTPS 헬스체크
    ├── config/
    │   └── site.conf          # 환경 설정 (설치 전 수정)
    ├── modules/               # 내부 모듈 (수정 불필요)
    ├── logs/                  # 스크립트 실행 로그
    └── templates/             # 설정 템플릿 (수정 불필요)
```

### 1-2. 설치 후 디렉토리 구조

설치 완료 후 INSTALL_BASE(기본: /opt/icr-solution)에 생성되는 구조입니다.

```
/opt/icr-solution/              # INSTALL_BASE
├── tomcat -> apache-tomcat-*   # Tomcat 심볼릭 링크
├── apache-tomcat-10.1.50/      # Tomcat 실제 디렉토리
│   ├── bin/
│   │   └── setenv.sh -> ../../config/tomcat/setenv.sh
│   ├── conf/
│   │   ├── server.xml -> ../../config/tomcat/server.xml
│   │   ├── web.xml -> ../../config/tomcat/web.xml
│   │   └── context.xml -> ../../config/tomcat/context.xml
│   ├── logs/                   # Tomcat 로그
│   └── icr-webapps/            # WAR 배포 디렉토리
│       └── ROOT/               # 압축 해제된 애플리케이션
├── java -> jdk-21.0.9+10       # Java 심볼릭 링크 (JAVA_SOURCE=bundled 시)
├── jdk-21.0.9+10/              # 번들 JDK 디렉토리 (JAVA_SOURCE=bundled 시)
├── config/
│   └── tomcat/                 # 실제 설정 파일
│       ├── server.xml
│       ├── web.xml
│       ├── context.xml
│       └── setenv.sh
├── backup/
│   └── war/                    # WAR 백업
├── logs/                       # 애플리케이션 로그 (Logback ICR_LOG_PATH)
│   ├── icr-app.log             # 애플리케이션 로그
│   └── icr-batch.log           # 배치 로그
└── data/                       # 데이터 디렉토리 (예약)
```

> **참고**: `JAVA_SOURCE=bundled` 설정 시에만 `java/`, `jdk-21.0.9+10/` 디렉토리가 생성됩니다.


## 2. 사전 준비

### 2-1. 시스템 요구사항

ICR 솔루션 설치를 위한 최소 요구사항입니다.

| 항목 | 요구사항 |
|------|----------|
| OS | Linux (커널 3.10 이상) |
| CPU | 2코어 이상 |
| 메모리 | 4GB 이상 (권장 8GB) |
| 디스크 | 10GB 이상 여유 공간 |
| JDK | Java 21 이상 (Temurin, OpenJDK, Corretto 등) |

### 2-2. JDK 설치 확인

서버에 JDK가 설치되어 있는지 확인합니다.

```bash
# Java 버전 확인
java -version

# JAVA_HOME으로 사용할 경로 확인
ls -d /usr/lib/jvm/*
```

**예상 출력:**
```
openjdk version "21.0.9" 2025-10-21 LTS
OpenJDK Runtime Environment Temurin-21.0.9+10 (build 21.0.9+10-LTS)
OpenJDK 64-Bit Server VM Temurin-21.0.9+10 (build 21.0.9+10-LTS, mixed mode, sharing)

/usr/lib/jvm/temurin-21-jdk-amd64
```

JDK가 설치되어 있지 않다면 시스템 관리자에게 설치를 요청하세요.

### 2-3. 디렉토리 및 권한

설치 경로 디렉토리를 생성하고 권한을 설정합니다.

```bash
# 설치 디렉토리 생성 (root 권한 필요)
sudo mkdir -p /opt/icr-solution

# 운영 계정에 소유권 부여 (예: icradm 계정)
sudo chown icradm:icradm /opt/icr-solution

# 권한 설정
sudo chmod 755 /opt/icr-solution
```

**예상 출력:**
```bash
# 생성 확인
ls -la /opt/ | grep icr-solution
drwxr-xr-x  2 icradm icradm 4096 Jan  1 10:00 icr-solution
```

| 항목 | 기본값 | 설명 |
|------|--------|------|
| 설치 경로 | /opt/icr-solution | site.conf의 INSTALL_BASE |
| 소유 계정 | icradm (권장) | Tomcat 실행 계정 |
| 권한 | 755 | 소유자 rwx, 그룹/기타 rx |

운영 계정이 없는 경우 생성:
```bash
# 운영 계정 생성 (선택)
sudo useradd -m -s /bin/bash icradm
```

### 2-4. 방화벽 설정

애플리케이션 접근을 위해 필요한 포트를 개방합니다.

```bash
# firewalld 사용 시
firewall-cmd --permanent --add-port=28080/tcp
firewall-cmd --permanent --add-port=28443/tcp
firewall-cmd --reload

# iptables 사용 시
iptables -A INPUT -p tcp --dport 28080 -j ACCEPT
iptables -A INPUT -p tcp --dport 28443 -j ACCEPT
```

| 포트 | 용도 | 필수 여부 |
|------|------|----------|
| 28080 | HTTP 접속 | 필수 |
| 28443 | HTTPS 접속 | HTTPS 사용 시 |


## 3. 설치

### 3-1. 패키지 배치

ICR 솔루션 패키지를 서버에 배치합니다.

```bash
# 패키지 압축 해제 (예시)
tar -xzf icr-solution-1.0.0.tar.gz -C /opt/

# 디렉토리 이동
cd /opt/icr-solution

# 디렉토리 구조 확인
ls -la
```

**예상 출력:**
```
drwxr-xr-x  5 root root 4096 Jan  1 10:00 .
drwxr-xr-x  3 root root 4096 Jan  1 10:00 ..
-rwxr-xr-x  1 root root  512 Jan  1 10:00 install.sh
-rwxr-xr-x  1 root root  512 Jan  1 10:00 uninstall.sh
-rwxr-xr-x  1 root root  512 Jan  1 10:00 setup-permissions.sh
drwxr-xr-x  2 root root 4096 Jan  1 10:00 packages
drwxr-xr-x  4 root root 4096 Jan  1 10:00 solution
```

### 3-2. 실행 권한 설정

Windows에서 작업 후 복사한 경우 실행 권한이 없을 수 있습니다.

```bash
# 권한 복구 스크립트 실행
bash setup-permissions.sh
```

**예상 출력:**
```
[setup-permissions] 스크립트 실행 권한 설정 시작
  - 루트: /opt/icr-solution/*.sh
  - solution/bin/*.sh
  - solution/modules/*.sh
[setup-permissions] 완료

이제 ./install.sh 또는 ./uninstall.sh 를 실행할 수 있습니다.
```

### 3-3. site.conf 설정

설치 전 사이트 환경에 맞게 설정 파일을 수정합니다.

```bash
# 설정 파일 편집
vi solution/config/site.conf
```

**필수 확인 항목:**

| 항목 | 설명 | 예시 |
|------|------|------|
| SITE | 사이트 식별자 | INFODEA |
| ENV | Spring 프로파일 | prod |
| JAVA_SOURCE | Java 소스 선택 | system, bundled |
| JAVA_HOME | JDK 설치 경로 (JAVA_SOURCE=system 시) | /usr/lib/jvm/temurin-21 |
| WAS_HTTP_PORT | HTTP 포트 | 28080 |
| WAR_NAME | WAR 파일명 | icr.war |
| JASYPT_ENCRYPTOR_PASSWORD | 암호화 키 | (보안상 변경 필수) |

**Java 설정 방식 선택:**

**방식 1: 시스템 Java 사용 (JAVA_SOURCE=system)**

서버에 이미 JDK가 설치되어 있는 경우:

```bash
JAVA_SOURCE=system
JAVA_HOME=/usr/lib/jvm/temurin-21
```

**방식 2: 번들 Java 사용 (JAVA_SOURCE=bundled)**

폐쇄망 환경이거나 서버에 JDK가 없는 경우 패키지에 포함된 JDK를 자동 설치:

```bash
JAVA_SOURCE=bundled
# JAVA_HOME은 자동 설정됨
```

- 필요 파일: `packages/JDK21_x64.tar.gz` (Intel/AMD) 또는 `packages/JDK21_arm.tar.gz` (ARM)
- 아키텍처 자동 감지
- 설치 위치: `$INSTALL_BASE/java` -> `$INSTALL_BASE/jdk-21.0.9+10`

### 3-4. 설치 실행

설정 확인 후 설치를 실행합니다.

```bash
# 설치 실행
./install.sh
```

**예상 출력 (JAVA_SOURCE=system):**
```
=========================================
ICR 솔루션 Tomcat 설치 시작
=========================================
[install-core] site.conf 로드: /opt/icr-solution/solution/config/site.conf
[install-core] SITE=INFODEA, ENV=prod
[install-core] JAVA_SOURCE=system
[install-core] JAVA_HOME=/usr/lib/jvm/temurin-21
[install-core] INSTALL_BASE=/opt/icr-solution
[install-core] TOMCAT_HOME=/opt/icr-solution/tomcat
[install-core] TOMCAT_DIST_NAME=apache-tomcat-10.1.50
[install-core] WAS_HTTP_PORT=28080, WAS_HTTPS_PORT=28443
[install-core] WAS_ENABLE_HTTPS=Y
[install-core] WAS_APP_BASE=icr-webapps
[install-core] JVM_XMS=512m, JVM_XMX=1024m
[install-core] INSTALL_BASE 디렉토리 준비: /opt/icr-solution
[install-core] Tomcat 패키지 확인: /opt/icr-solution/packages/apache-tomcat-10.1.50.tar.gz
[install-core] Tomcat 설치 대상: /opt/icr-solution/apache-tomcat-10.1.50
[install-core] Tomcat 압축 해제
[install-core] TOMCAT_HOME 심볼릭 링크: /opt/icr-solution/tomcat -> apache-tomcat-10.1.50
[install-core] 기본 webapps 정리
[install-core] appBase 디렉토리: /opt/icr-solution/apache-tomcat-10.1.50/icr-webapps
[install-core] 설정 파일 생성 (없을 때만)
[install-core] server.xml 렌더링 -> /opt/icr-solution/config/tomcat/server.xml
[install-core] web.xml 복사 -> /opt/icr-solution/config/tomcat/web.xml
[install-core] context.xml 복사 -> /opt/icr-solution/config/tomcat/context.xml
[install-core] setenv.sh 렌더링 -> /opt/icr-solution/config/tomcat/setenv.sh
[install-core] Tomcat conf/bin 심볼릭 링크 설정
[install-core] 링크 완료:
[install-core]   /opt/icr-solution/tomcat/conf/server.xml -> server.xml
[install-core]   /opt/icr-solution/tomcat/conf/context.xml -> context.xml
[install-core]   /opt/icr-solution/tomcat/conf/web.xml -> web.xml
[install-core]   /opt/icr-solution/tomcat/bin/setenv.sh -> setenv.sh
[install-core] WAR 배포: /opt/icr-solution/packages/icr.war -> /opt/icr-solution/apache-tomcat-10.1.50/icr-webapps/icr.war
[install-core] WAR 배포 완료
[install-core] 스크립트 실행 권한 설정
[install-core] 실행 권한 설정 완료
=========================================
ICR 솔루션 Tomcat 설치 완료
=========================================

Tomcat 시작: ./solution/bin/start.sh
상태 확인:   ./solution/bin/check.sh
```

> **참고**: 스크립트 실행 로그는 `solution/logs/install-{YYYYMMDD}.log`에 저장됩니다.

### 3-5. 설치 검증

설치가 정상적으로 완료되었는지 확인합니다.

```bash
# 종합 점검 실행
./solution/bin/check.sh
```

**예상 출력:**
```
------------------------------------------------------------
1) 서비스 상태
------------------------------------------------------------
[2025-01-01 10:05:00] Tomcat STOPPED: /opt/icr-solution/tomcat

------------------------------------------------------------
2) Java 프로세스 정보
------------------------------------------------------------

------------------------------------------------------------
3) 포트 리슨 상태
------------------------------------------------------------

------------------------------------------------------------
4) WAR 배포 파일
------------------------------------------------------------
APP_BASE_DIR = /opt/icr-solution/tomcat/icr-webapps
WAR_PATH     = /opt/icr-solution/tomcat/icr-webapps/icr.war
-rw-r--r-- 1 root root 123456789 Jan  1 10:00 /opt/icr-solution/tomcat/icr-webapps/icr.war

------------------------------------------------------------
5) 헬스체크 (선택)
------------------------------------------------------------
[2025-01-01 10:05:00] 헬스체크 생략. --with-health 옵션으로 활성화

------------------------------------------------------------
6) 로그 tail (선택)
------------------------------------------------------------
[2025-01-01 10:05:00] 로그 출력 생략. --tail <N> 옵션으로 활성화

------------------------------------------------------------
점검 완료
------------------------------------------------------------
```


## 4. 제거

### 4-1. 기본 제거 (Tomcat만)

Tomcat만 삭제하고 설정/로그/데이터는 유지합니다.

```bash
# 기본 제거 실행
./uninstall.sh
```

**예상 출력:**
```
[2025-01-01 10:10:00] ICR 솔루션 제거 시작
[2025-01-01 10:10:00] CONF_FILE     = /opt/icr-solution/solution/config/site.conf
[2025-01-01 10:10:00] INSTALL_BASE  = /opt/icr-solution
[2025-01-01 10:10:00] TOMCAT_HOME   = /opt/icr-solution/tomcat
========================================
삭제 대상
========================================
[2025-01-01 10:10:00] [기본] Tomcat 심볼릭 링크: /opt/icr-solution/tomcat
[2025-01-01 10:10:00] [기본] Tomcat 실제 디렉토리: /opt/icr-solution/apache-tomcat-10.1.50
[2025-01-01 10:10:00]
[2025-01-01 10:10:00] 유지되는 디렉토리:
[2025-01-01 10:10:00]   - /opt/icr-solution/config
[2025-01-01 10:10:00]   - /opt/icr-solution/logs
[2025-01-01 10:10:00]   - /opt/icr-solution/data
[2025-01-01 10:10:00]   - /opt/icr-solution/backup
========================================

정말 삭제하시겠습니까? (y/N): y
[2025-01-01 10:10:05] 서비스 중지 중...
[2025-01-01 10:10:05] 이미 중지됨. 중지 생략.
[2025-01-01 10:10:05] Tomcat 디렉토리 삭제 시작
[2025-01-01 10:10:05] 심볼릭 링크 삭제: /opt/icr-solution/tomcat
[2025-01-01 10:10:05] Tomcat 디렉토리 삭제: /opt/icr-solution/apache-tomcat-10.1.50
[2025-01-01 10:10:05] Tomcat 삭제 완료
========================================
ICR 솔루션 제거 완료

유지된 디렉토리:
  - /opt/icr-solution/config
  - /opt/icr-solution/logs
  - /opt/icr-solution/data
  - /opt/icr-solution/backup

전체 삭제가 필요하면: uninstall.sh --full
========================================
```

### 4-2. 전체 제거

설정/로그/데이터를 포함한 전체 삭제입니다.

```bash
# 전체 제거 실행
./uninstall.sh --full
```

**예상 출력:**
```
========================================
삭제 대상
========================================
[2025-01-01 10:15:00] [FULL] INSTALL_BASE 내용물 전체: /opt/icr-solution/* (폴더 자체는 유지)
========================================

경고: INSTALL_BASE 내용물 전체가 삭제됩니다!
      설정, 로그, 데이터, 백업 모두 삭제됩니다.
      (폴더 자체는 유지됩니다)

정말 삭제하시겠습니까? (y/N): y
[2025-01-01 10:15:05] 서비스 중지 중...
[2025-01-01 10:15:05] INSTALL_BASE 내용물 전체 삭제 시작
[2025-01-01 10:15:05] 전체 삭제 (폴더 유지, 내용물만 삭제): /opt/icr-solution/*
[2025-01-01 10:15:05] 전체 삭제 완료
========================================
ICR 솔루션 제거 완료
========================================
```

### 4-3. 제거 미리보기

실제 삭제 없이 삭제 대상만 확인합니다.

```bash
# 삭제 대상 미리보기
./uninstall.sh --dry-run
```

**예상 출력:**
```
========================================
삭제 대상
========================================
[2025-01-01 10:20:00] [기본] Tomcat 심볼릭 링크: /opt/icr-solution/tomcat
[2025-01-01 10:20:00] [기본] Tomcat 실제 디렉토리: /opt/icr-solution/apache-tomcat-10.1.50
========================================
[2025-01-01 10:20:00] [DRY-RUN] rm -f "/opt/icr-solution/tomcat"
[2025-01-01 10:20:00] [DRY-RUN] rm -rf "/opt/icr-solution/apache-tomcat-10.1.50"
```


## 5. 서비스 제어

### 5-1. 시작

Tomcat 서비스를 시작합니다.

```bash
# 서비스 시작
./solution/bin/start.sh
```

**예상 출력:**
```
[2025-01-01 10:30:00] CONF_FILE     = /opt/icr-solution/solution/config/site.conf
[2025-01-01 10:30:00] INSTALL_BASE  = /opt/icr-solution
[2025-01-01 10:30:00] TOMCAT_HOME   = /opt/icr-solution/tomcat
[2025-01-01 10:30:00] WAS_APP_BASE  = icr-webapps
[2025-01-01 10:30:00] MODE          = bin-only (startup/shutdown)
[2025-01-01 10:30:00] DRY_RUN       = N
[2025-01-01 10:30:00] SVC_START_TIMEOUT_SEC = 30
[2025-01-01 10:30:00] SVC_STOP_TIMEOUT_SEC  = 30
[2025-01-01 10:30:00] SVC_STOP_FORCEKILL    = Y
[2025-01-01 10:30:00] 시작: /opt/icr-solution/tomcat/bin/startup.sh
[2025-01-01 10:30:01] 시작 완료
```

### 5-2. 중지

Tomcat 서비스를 중지합니다.

```bash
# 서비스 중지
./solution/bin/stop.sh
```

**예상 출력:**
```
[2025-01-01 10:35:00] CONF_FILE     = /opt/icr-solution/solution/config/site.conf
[2025-01-01 10:35:00] INSTALL_BASE  = /opt/icr-solution
[2025-01-01 10:35:00] TOMCAT_HOME   = /opt/icr-solution/tomcat
[2025-01-01 10:35:00] WAS_APP_BASE  = icr-webapps
[2025-01-01 10:35:00] MODE          = bin-only (startup/shutdown)
[2025-01-01 10:35:00] DRY_RUN       = N
[2025-01-01 10:35:00] SVC_START_TIMEOUT_SEC = 30
[2025-01-01 10:35:00] SVC_STOP_TIMEOUT_SEC  = 30
[2025-01-01 10:35:00] SVC_STOP_FORCEKILL    = Y
[2025-01-01 10:35:00] 중지: /opt/icr-solution/tomcat/bin/shutdown.sh
[2025-01-01 10:35:02] 중지 완료
```

### 5-3. 상태 확인

현재 서비스 상태를 확인합니다.

### 5-4. 서비스 제어 타임아웃 설정

서비스 시작/중지 타임아웃 및 강제종료 동작을 site.conf에서 설정할 수 있습니다.

```bash
# site.conf 고급 설정 (섹션 8. 서비스 제어 설정)
SVC_START_TIMEOUT_SEC=30        # 시작 대기 시간 (기본: 30초)
SVC_STOP_TIMEOUT_SEC=30         # 중지 대기 시간 (기본: 30초)
SVC_STOP_FORCEKILL=Y            # 타임아웃 시 강제종료 (Y/N, 기본: Y)
SVC_STOP_FORCEKILL_GRACE_SEC=1  # 강제종료 후 대기 (기본: 1초)
```

| 설정 | 기본값 | 설명 |
|------|--------|------|
| SVC_START_TIMEOUT_SEC | 30 | Tomcat 시작 후 프로세스 감지까지 최대 대기 시간 |
| SVC_STOP_TIMEOUT_SEC | 30 | shutdown.sh 실행 후 종료 감지까지 최대 대기 시간 |
| SVC_STOP_FORCEKILL | Y | 타임아웃 시 `pkill -f`로 강제 종료 여부 |
| SVC_STOP_FORCEKILL_GRACE_SEC | 1 | 강제 종료 명령 후 추가 대기 시간 |

**느린 서버나 무거운 애플리케이션의 경우:**
```bash
SVC_START_TIMEOUT_SEC=60        # 시작 대기 60초로 증가
SVC_STOP_TIMEOUT_SEC=60         # 중지 대기 60초로 증가
```

```bash
# 종합 점검 (서비스 상태 포함)
./solution/bin/check.sh
```

**실행 중일 때 예상 출력:**
```
------------------------------------------------------------
1) 서비스 상태
------------------------------------------------------------
[2025-01-01 10:40:00] Tomcat RUNNING: /opt/icr-solution/tomcat

------------------------------------------------------------
2) Java 프로세스 정보
------------------------------------------------------------
root    12345  1  2.5 2048576 512000 ?  Sl  10:30   0:45 /usr/lib/jvm/temurin-21/bin/java -Djava.util.logging.config.file=/opt/icr-solution/tomcat/conf/logging.properties ...

------------------------------------------------------------
3) 포트 리슨 상태
------------------------------------------------------------
LISTEN  0  100  *:28080  *:*  users:(("java",pid=12345,fd=45))
LISTEN  0  100  *:28443  *:*  users:(("java",pid=12345,fd=46))
```


## 6. WAR 배포

### deploy-war.sh 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--war <path>` | 배포할 WAR 파일 경로 | packages/${WAR_NAME} |
| `--restart` | 재기동 수행 | 기본 |
| `--no-restart` | 재기동 안 함 | - |
| `--keep <N>` | 백업 보관 개수 | 20 |
| `--wait-health` | HTTP 헬스체크 수행 | OFF |
| `--health-path <path>` | 헬스체크 경로 | /icr/login |
| `--health-retry <N>` | 재시도 횟수 | 5 |
| `--health-interval <sec>` | 재시도 간격 | 2초 |
| `--check-https` | HTTPS 헬스체크도 추가 수행 | OFF |
| `--dry-run` | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | 도움말 | - |

### 6-1. 기본 배포

새로운 WAR 파일을 배포합니다. 서비스 재기동이 포함됩니다.

```bash
# 새 WAR 파일을 packages/ 디렉토리에 복사
cp /path/to/new/icr.war ./packages/

# WAR 배포 실행
./solution/bin/deploy-war.sh
```

**예상 출력:**
```
[2025-01-01 11:00:00] CONF_FILE     = /opt/icr-solution/solution/config/site.conf
[2025-01-01 11:00:00] INSTALL_BASE  = /opt/icr-solution
[2025-01-01 11:00:00] TOMCAT_HOME   = /opt/icr-solution/tomcat
[deploy-war] WAR_SRC        = /opt/icr-solution/packages/icr.war
[deploy-war] WAR_DST        = /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] DO_RESTART     = Y
[deploy-war] KEEP_N         = 20
[deploy-war] WAIT_HEALTH    = N
[2025-01-01 11:00:00] 중지: /opt/icr-solution/tomcat/bin/shutdown.sh
[2025-01-01 11:00:02] 중지 완료
[deploy-war] 백업: /opt/icr-solution/tomcat/icr-webapps/icr.war -> /opt/icr-solution/backup/war/icr.war.20250101_110000
[deploy-war] 배포: /opt/icr-solution/packages/icr.war -> /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] 오래된 백업 정리 (최근 20개 유지)
[2025-01-01 11:00:02] 시작: /opt/icr-solution/tomcat/bin/startup.sh
[2025-01-01 11:00:03] 시작 완료
[deploy-war] 배포 완료
```

### 6-2. 무중단 배포 (WAR만 교체)

서비스 재기동 없이 WAR 파일만 교체합니다. 다음 재기동 시 적용됩니다.

```bash
# WAR만 교체 (재기동 없음)
./solution/bin/deploy-war.sh --no-restart
```

**예상 출력:**
```
[deploy-war] WAR_SRC        = /opt/icr-solution/packages/icr.war
[deploy-war] WAR_DST        = /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] DO_RESTART     = N
[deploy-war] 백업: /opt/icr-solution/tomcat/icr-webapps/icr.war -> /opt/icr-solution/backup/war/icr.war.20250101_110500
[deploy-war] 배포: /opt/icr-solution/packages/icr.war -> /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] 오래된 백업 정리 (최근 20개 유지)
[deploy-war] 재기동 생략 (--no-restart)
[deploy-war] 배포 완료
```

### 6-3. 배포 후 헬스체크

배포 후 애플리케이션이 정상 기동되었는지 확인합니다.

```bash
# 배포 + 헬스체크
./solution/bin/deploy-war.sh --wait-health
```

**예상 출력:**
```
[deploy-war] WAR_SRC        = /opt/icr-solution/packages/icr.war
[deploy-war] WAR_DST        = /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] DO_RESTART     = Y
[deploy-war] WAIT_HEALTH    = Y
[2025-01-01 11:10:00] 중지: /opt/icr-solution/tomcat/bin/shutdown.sh
[2025-01-01 11:10:02] 중지 완료
[deploy-war] 백업: ...
[deploy-war] 배포: ...
[2025-01-01 11:10:02] 시작: /opt/icr-solution/tomcat/bin/startup.sh
[2025-01-01 11:10:03] 시작 완료
[deploy-war] 헬스체크 대기 (HTTP)...
[2025-01-01 11:10:05] 헬스체크 시도 1/5...
[2025-01-01 11:10:05] WARMING UP (응답 대기 중): http://127.0.0.1:28080/icr/login
[2025-01-01 11:10:07] 헬스체크 시도 2/5...
[2025-01-01 11:10:07] WARMING UP (응답 대기 중): http://127.0.0.1:28080/icr/login
[2025-01-01 11:10:09] 헬스체크 시도 3/5...
[2025-01-01 11:10:09] OK 200: http://127.0.0.1:28080/icr/login
[deploy-war] 배포 완료
```

### 6-4. 외부 WAR 직접 배포

packages/ 디렉토리를 거치지 않고 외부 WAR 파일을 직접 배포합니다.

```bash
# 외부 경로의 WAR 직접 배포
./solution/bin/deploy-war.sh --war /tmp/icr.war

# 외부 WAR + 헬스체크
./solution/bin/deploy-war.sh --war /tmp/icr.war --wait-health
```

**예상 출력:**
```
[deploy-war] WAR_SRC        = /tmp/icr.war
[deploy-war] WAR_DST        = /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] DO_RESTART     = Y
[deploy-war] 백업: ...
[deploy-war] 배포: /tmp/icr.war -> /opt/icr-solution/tomcat/icr-webapps/icr.war
[deploy-war] 배포 완료
```

### 6-5. HTTP + HTTPS 헬스체크 (CI/CD 권장)

배포 후 HTTP와 HTTPS 모두 정상인지 확인합니다.

```bash
# HTTP + HTTPS 헬스체크
./solution/bin/deploy-war.sh --wait-health --check-https

# 경로 지정 + 재시도 조정
./solution/bin/deploy-war.sh --wait-health --check-https --health-path /api/health --health-retry 10
```

**예상 출력:**
```
[deploy-war] 헬스체크 대기 (HTTP)...
[2025-01-01 11:10:09] OK 200: http://127.0.0.1:28080/icr/login
[deploy-war] 헬스체크 대기 (HTTPS)...
[2025-01-01 11:10:10] OK 200: https://127.0.0.1:28443/icr/login
[deploy-war] 배포 완료
```

## 7. 운영 점검

### 7-1. 종합 점검 (check.sh)

서비스 상태, 프로세스, 포트, WAR 파일을 한번에 점검합니다.

**옵션:**

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--with-health` | 헬스체크 실행 | OFF |
| `--health-path <path>` | 헬스체크 경로 | /icr/login |
| `--health-retry <N>` | 재시도 횟수 | 3 |
| `--health-interval <sec>` | 재시도 간격 | 1초 |
| `--tail <N>` | catalina.out 마지막 N줄 출력 | 0 (생략) |
| `--dry-run` | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | 도움말 | - |

**사용 예시:**

```bash
# 기본 점검
./solution/bin/check.sh

# 헬스체크 포함
./solution/bin/check.sh --with-health

# 헬스체크 경로 변경
./solution/bin/check.sh --with-health --health-path /api/health

# 로그 출력 포함
./solution/bin/check.sh --tail 100

# 전체 점검 (헬스체크 + 로그)
./solution/bin/check.sh --with-health --tail 100
```

### 7-2. HTTP 헬스체크 (health.sh)

HTTP 엔드포인트 응답을 확인합니다.

**옵션:**

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--path <path>` | 체크 경로 | /icr/login |
| `--timeout <sec>` | curl 타임아웃 | 5초 |
| `--retry <N>` | 재시도 횟수 | 3 |
| `--interval <sec>` | 재시도 간격 | 1초 |
| `--verbose` | 실패 시 응답 헤더 출력 (000 제외) | OFF |
| `--dry-run` | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | 도움말 | - |

**성공 판정:** HTTP 200, 30x, 401, 403

**사용 예시:**

```bash
# 기본 헬스체크
./solution/bin/health.sh

# 경로 변경
./solution/bin/health.sh --path /api/health

# 재시도 횟수 변경
./solution/bin/health.sh --retry 10

# 타임아웃 및 간격 조정
./solution/bin/health.sh --timeout 10 --interval 3

# 상세 출력 (실패 시 응답 헤더 표시)
./solution/bin/health.sh --verbose
```

**성공 시 예상 출력:**
```
[2025-01-01 12:00:00] 헬스체크 시도 1/3...
[2025-01-01 12:00:00] OK 200: http://127.0.0.1:28080/icr/login
```

**실패 시 예상 출력:**
```
[2025-01-01 12:00:00] 헬스체크 시도 1/3...
[2025-01-01 12:00:00] FAIL 500: http://127.0.0.1:28080/icr/login
[2025-01-01 12:00:01] 헬스체크 시도 2/3...
[2025-01-01 12:00:01] FAIL 500: http://127.0.0.1:28080/icr/login
[2025-01-01 12:00:02] 헬스체크 시도 3/3...
[2025-01-01 12:00:02] FAIL 500: http://127.0.0.1:28080/icr/login
[2025-01-01 12:00:02] 헬스체크 실패
```

### 7-3. HTTPS 헬스체크 (health-https.sh)

HTTPS 엔드포인트 응답을 확인합니다.

**옵션:**

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--path <path>` | 체크 경로 | /icr/login |
| `--timeout <sec>` | curl 타임아웃 | 5초 |
| `--retry <N>` | 재시도 횟수 | 3 |
| `--interval <sec>` | 재시도 간격 | 1초 |
| `--verify` | TLS 인증서 검증 ON | OFF (curl -k) |
| `--verbose` | 실패 시 응답 헤더 출력 | OFF |
| `--dry-run` | 실제 실행 없이 명령만 출력 | - |
| `-h, --help` | 도움말 | - |

**성공 판정:** HTTP 200, 30x, 401, 403

> **용도:** HTTPS 커넥터/인증서/포트 점검용. 평소에는 HTTP 헬스체크를 사용하고, HTTPS 이슈 트러블슈팅 시에만 사용합니다.

**사용 예시:**

```bash
# 기본 HTTPS 헬스체크 (인증서 검증 OFF)
./solution/bin/health-https.sh

# 인증서 검증 ON (실제 인증서 유효성 검사)
./solution/bin/health-https.sh --verify

# 재시도 횟수 + 상세 출력
./solution/bin/health-https.sh --retry 5 --verbose

# 경로 변경
./solution/bin/health-https.sh --path /api/health
```

**예상 출력:**
```
[2025-01-01 12:05:00] HTTPS 헬스체크 시도 1/3...
[2025-01-01 12:05:00] OK 200: https://127.0.0.1:28443/icr/login
```


## 8. 트러블슈팅

### 8-0. 스크립트 로그 확인

모든 스크립트 실행 로그는 `solution/logs/`에 저장됩니다.

```bash
# 오늘 실행된 스크립트 로그 목록
ls -la solution/logs/

# 설치 로그 확인
cat solution/logs/install-$(date +%Y%m%d).log

# 배포 로그 확인
cat solution/logs/deploy-war-$(date +%Y%m%d).log

# 시작/중지 로그 확인
cat solution/logs/start-$(date +%Y%m%d).log
cat solution/logs/stop-$(date +%Y%m%d).log
```

### 8-1. 설치 오류

**JAVA_HOME 관련 오류**

```
[install-core][ERROR] JAVA_HOME 미설정. site.conf에 JAVA_HOME=/path/to/jdk 추가 필요
```

해결: site.conf에서 JAVA_HOME 경로를 확인하고 수정합니다.

```bash
# JDK 경로 확인
ls -d /usr/lib/jvm/*

# site.conf 수정
vi solution/config/site.conf
# JAVA_HOME=/usr/lib/jvm/temurin-21 로 수정
```

**Tomcat 패키지 없음 오류**

```
[install-core][ERROR] Tomcat 패키지 없음: /opt/icr-solution/packages/apache-tomcat-10.1.50.tar.gz
```

해결: packages/ 디렉토리에 Tomcat 패키지가 있는지 확인합니다.

```bash
ls -la packages/
# apache-tomcat-10.1.50.tar.gz 파일이 있어야 함
```

### 8-2. 시작 실패

**시작 타임아웃**

```
[2025-01-01 10:31:00] ERROR: 시작 타임아웃 (30초)
```

해결: 로그를 확인하여 원인을 파악합니다.

```bash
# Tomcat 로그 확인
tail -200 /opt/icr-solution/tomcat/logs/catalina.out

# 포트 충돌 확인
ss -lntp | grep 28080
```

**이미 실행 중**

```
[2025-01-01 10:30:00] 이미 실행 중. 시작 생략.
```

해결: 정상 상태입니다. 재시작이 필요하면 먼저 중지 후 시작합니다.

```bash
./solution/bin/stop.sh
./solution/bin/start.sh
```

### 8-3. 헬스체크 실패

**Tomcat 미실행**

```
[2025-01-01 12:00:00] 헬스체크 중단: Tomcat 미실행 상태
```

해결: 서비스를 먼저 시작합니다.

```bash
./solution/bin/start.sh
./solution/bin/health.sh
```

**애플리케이션 오류 (HTTP 500)**

```
[2025-01-01 12:00:00] FAIL 500: http://127.0.0.1:28080/icr/login
```

해결: 애플리케이션 로그를 확인합니다.

```bash
# Tomcat 내부 로그 확인
tail -500 /opt/icr-solution/tomcat/logs/catalina.out | grep -i error

# 애플리케이션 로그 확인 (Logback)
tail -500 /opt/icr-solution/logs/icr-app.log | grep -i error

# 배치 로그 확인
tail -500 /opt/icr-solution/logs/icr-batch.log | grep -i error
```

**WARMING UP 상태 (HTTP 000)**

```
[2025-01-01 12:00:00] WARMING UP (응답 대기 중): http://127.0.0.1:28080/icr/login
```

**의미:**
- HTTP 응답 코드 000 = 서버에 연결되지 않음 (아직 리슨 전)
- 애플리케이션이 아직 기동 중이므로 **정상 상태**입니다
- FAIL이 아닌 "WARMING UP"으로 표시되며 재시도를 계속합니다
- 일정 시간 후에도 계속 000이면 애플리케이션 로그 확인 필요

**조치:**
- 잠시 대기하면 자동으로 200 OK로 전환됩니다
- 헬스체크 재시도 횟수를 늘려볼 수 있습니다: `--retry 10`

### 8-4. 포트 충돌

**포트 사용 중 확인**

```bash
# 포트 사용 현황 확인
ss -lntp | grep -E '28080|28443|8005'
```

**예상 출력 (충돌 시):**
```
LISTEN  0  100  *:28080  *:*  users:(("httpd",pid=9999,fd=4))
```

해결: 해당 포트를 사용하는 프로세스를 확인하고, site.conf에서 포트를 변경하거나 기존 프로세스를 중지합니다.

```bash
# 포트 사용 프로세스 확인
ps -ef | grep 9999

# site.conf에서 포트 변경
vi solution/config/site.conf
# WAS_HTTP_PORT=28081 로 변경

# 재설치
ICR_FORCE_REGEN=Y ./install.sh
```

### 8-5. 종료 코드 정리

스크립트 종료 코드로 성공/실패를 판단할 수 있습니다. CI/CD 파이프라인에서 유용합니다.

| 종료 코드 | 의미 | 조치 |
|-----------|------|------|
| 0 | 성공 | - |
| 1 | 일반 오류 | 스크립트 로그 확인 (`solution/logs/`) |
| 2 | 설정 오류 | site.conf 필수 항목 확인 |
| 3 | 파일 없음 | packages/icr.war 또는 Tomcat 패키지 확인 |
| 4 | 헬스체크 실패 | 애플리케이션 로그 확인 |

**CI/CD 예시 (bash):**
```bash
./solution/bin/deploy-war.sh --wait-health
if [ $? -ne 0 ]; then
    echo "배포 실패"
    exit 1
fi
echo "배포 성공"
```

**Jenkins Pipeline 예시:**
```groovy
sh './solution/bin/deploy-war.sh --wait-health --check-https'
// 실패 시 자동으로 파이프라인 중단됨
```
